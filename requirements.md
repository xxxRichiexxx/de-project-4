# Выполнение проекта:
### 1) Изучаем источник данных

Выполним запрос к эндпоинту /restaurants
     
    [
        {
            "_id": "626a81cfefa404208fe9abae",
            "name": "Кофейня №1"
        },
        {
            "_id": "a51e4e31ae4602047ec52534",
            "name": "Кубдари"
        },
        {
            "_id": "ebfa4c9b8dadfc1da37ab58d",
            "name": "PLove"
        },
        {
            "_id": "ef8c42c19b7518a9aebec106",
            "name": "Вкус Индии"
        }
    ]

Данная информация не используется при построении витрины, т.е ее можно не загружать в хранилище.

Выполним запрос к эндпоинту /couriers

    [
        {
            "_id": "0074hr6m1vrq8hn7n4kay2b",
            "name": "Евгений Смирнов"
        },
        {
            "_id": "04e6hdabli1vzc8g9l2s6wa",
            "name": "Снежанна Волкова"
        },
        {
            "_id": "06jyvwp141xhh9ekza25usd",
            "name": "Евгения Егорова"
        },
        ...
    ]

Данная информация используется при расчетах в витрине (метрики считаются в разрезе курьеров)

Выполним запрос к эндпоинту /deliveries

    [
        {
            "order_id": "632902933868c6ca6c476d2e",
            "order_ts": "2022-09-20 00:00:19.624000",
            "delivery_id": "vv6yfrrotjtw6a77sq6nlx1",
            "courier_id": "tz1zvnpnzx0fes582xkh02n",
            "address": "Ул. Красная, 13, кв. 326",
            "delivery_ts": "2022-09-20 01:18:22.236000",
            "rate": 5,
            "sum": 4203,
            "tip_sum": 630
        },
        {
            "order_id": "632903be3a231e3ec2659f31",
            "order_ts": "2022-09-20 00:05:18.128000",
            "delivery_id": "k7emcfb9chuv7usmqd5we5m",
            "courier_id": "lajzzo434vqd5lld5yx6igh",
            "address": "Ул. Новая, 2, кв. 115",
            "delivery_ts": "2022-09-20 01:05:22.207000",
            "rate": 5,
            "sum": 2770,
            "tip_sum": 277
        },
        {
            "order_id": "632904e95c5a7427acb4080d",
            "order_ts": "2022-09-20 00:10:17.665000",
            "delivery_id": "l1oya54uwtql9hkl67w5ppn",
            "courier_id": "qwjuroycre48mk25kwfz5gg",
            "address": "Ул. Новая, 14, кв. 398",
            "delivery_ts": "2022-09-20 00:28:25.063000",
            "rate": 5,
            "sum": 2874,
            "tip_sum": 287
        },
        ...
    ]

Данный эндпоинт возвращает основную информацию, необходимую для расчета метрик.

### 1) Проектирование слоев хранилища

Для решения поставленной задачи будем использовать три слоя:
* stg - для храниения полученных из API данных в исходном виде. Полученные json будем сохранять в поле типа TEXT.
* dds - для хранения нормализованных данных. 

![image info](https://github.com/xxxRichiexxx/de-project-4/blob/main/media/модель.PNG)

* cdm - для хранения витрины данных

### 2) Создание таблиц в слоях хранилища

Скрипты создания таблиц см см. src\ddl.sql

### 3) Загрузка данных

В слое stg таблицы не имеют связей и ограничений, поэтому при загрузке данных в него порядок не важен, и данные можно загружать независимо друг от друга. На этом этапе нет сложных преобразований.

см src\dag.py (процедура get_data())

API не отдает все данные за один запрос, поэтому будем опрашивать эндпоинты со смещением в 50 записей (параметр offset) пока API не вернет пустой список. Кроме этого, при работе с эндпоинтом /deliveries в строку запроса будем передавать диапазон дат за который требуется получить информацию о доставках (параметры from и to):

    https://d5d04q7d963eapoepsqr.apigw.yandexcloud.net/deliveries/?offset=0&from={дата выполнения ОАГ} 00:00:00&to{дата выполнения ОАГ} 23:59:59

В вслое dds таблицы имеют связи и ограничения, порядок загрузки данных в этот слой имеет значение. В первую очередь загружаем данные в таблицы измерений, далее в таблицу фактов.

Скрипты загрузки данных см. src\dags\sql\

В конечном итоге граф задач будет выглядеть следующим образом

![image info](https://github.com/xxxRichiexxx/de-project-4/blob/main/media/граф.PNG)

### 4) Создание витрины

см. src\dags\sql\update_cdm_dm_courier_ledger.sql





